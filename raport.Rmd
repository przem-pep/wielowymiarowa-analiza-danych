---
title: "Analiza zbioru danych mieszkania"
subtitle: "Wielowymiarowa analiza danych"
author: "Przemysław Peplinski, Wiktor Galewski, Mikołaj Zalewski"
date: "`r Sys.Date()`"
output: pdf_document
toc: true
toc-title: "Spis treści"
fontsize: 12pt

header-includes:
  - \setcounter{secnumdepth}{2}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE)
```

```{r wczytanie-pakietow, include=FALSE}

library(tidyverse)
library(readxl)
library(missForest)
library(corrplot)
library(psych)
library(factoextra)
library(ggcorrplot)

```

```{r definiowanie-funkcji, include=FALSE}

# Histogram dla podanej zmiennej

histogram <- function(data, x, binwidth = NULL, bins = NULL, title) {
  ggplot(data, aes(x = {{ x }})) +
  geom_histogram(binwidth = binwidth, bins = bins, fill = "firebrick") +
  labs(x = NULL,
       y = NULL,
       title = title) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5, size = 16))
}


```

```{r wczytanie-danych, include=FALSE}

dane <- read_excel("mieszkania.xlsx")

```

# Wstęp

## Autorzy

Autorami są... Wkład w projekt prezentował się następująco...

## Motywacja i cele

Coś tam...

## Opis projektu

Coś tam...

# Opis danych

Dane pochodzą.../Dane zostały zebrane...

```{r przeglad-danych}
glimpse(dane)
```

Opisać zmienne...

Wśród zmiennych niepotrzebnych do analizy można wymienić link, tytuł, opis oraz numer telefonu. Zmienne te zostaną zatem usunięte.

# Czyszczenie danych

## Walidacja

Tak

```{r}
glimpse(dane)
```


```{r walidacja}

```


## Obsługa braków wartości

Kilka zmiennych do usunięcia, dla niektórych trzeba usunąć obserwacje, w innych imputować wg obliczeń.

```{r czyszczenie-danych}
# usuniecie duplikatow po linku
dane <- distinct(dane, Link, .keep_all = TRUE)

# usuniecie zbednych kolumn
dane <- dane %>%
  select(c(-Link, -Tytuł, -Opis, -`Numer telefonu`, -Ocena, -`Liczba pięter`))

# modyfikacja ogloszenia jako zmienna binarna
dane <- dane %>%
  mutate(`Data modyfikacji` = as.integer(!is.na(`Data modyfikacji`)))

# cena za metr - usuniecie bledow i NA
dane <- dane %>%
  filter(`Cena za metr` >= 1100 & `Cena za metr` <= 63000)

# powierzchnia - usuniecie bledow
dane <- dane %>%
  filter(Powierzchnia >= 14 & Powierzchnia <= 900)

# pietro - usuniecie bledow i NA
dane <- dane %>%
  filter(Piętro >= 0 & Piętro <= 20)

# liczba pokoi - poprawa i wymazanie bledow
dane <- dane %>%
  mutate(`Liczba pokoi` = case_when(
    `Liczba pokoi` %in% c(21, 23) ~ 2,
    `Liczba pokoi` >= 1 & `Liczba pokoi` <= 24 ~ `Liczba pokoi`,
    TRUE ~ NA_real_))

# ogloszeniodawca i rynek - usuniecie NA
dane <- dane %>%
  filter(!is.na(Ogłoszeniodawca) & !is.na(Rynek))

# rok budowy - wymazanie bledow
dane <- dane %>%
  mutate(`Rok budowy` = if_else(between(`Rok budowy`, 1780, 2028), 
                                `Rok budowy`, NA_real_))

# rodzaj budynku - pozostale jako NA
dane <- dane %>%
  mutate(`Rodzaj budynku` = na_if(`Rodzaj budynku`, "Pozostałe"))

# usuniecie obserwacji, gdzie zarowno rok budowy, jak i rodzaj budynku sa NA
dane <- dane %>%
  filter(!(is.na(`Rok budowy`) & is.na(`Rodzaj budynku`)))

# modyfikacja typow niektorych zmiennych
dane <- dane %>%
  mutate(`Data dodania` = as.numeric(as.Date(`Data dodania`))) %>%
  mutate(across(c(Dzielnica, `Rodzaj budynku`, Portal), as.factor)) %>%
  mutate(Rynek = as.integer(Rynek == "Pierwotny")) %>%
  mutate(`Rok budowy` = as.integer(`Rok budowy`)) %>%
  mutate(Ogłoszeniodawca = as.integer(Ogłoszeniodawca == "Agencja"))

# imputacja brakow danych (liczba pokoi, rok budowy, rodzaj budynku)
imputacje <- missForest(as.data.frame(dane), verbose = TRUE)
dane <- imputacje$ximp
```

## Obsługa obserwacji odstających

Jako tako zostawiamy

# Analiza eksploracyjna

## Statystyki opisowe

```{r statystyki-opisowe}
summary(dane)
```


## Analiza rozkładów

Histogramy zmiennych numerycznych, wykresy kolumnowe zmiennych kategorycznych

```{r histogramy, fig.align='center', fig.width=6, fig.height=4}

# Histogram pięter

histogram(
  data = dane,
  x = Piętro,
  binwidth = 1,
  title = "Rozkład pięter mieszkań"
)

# Histogram cen mieszkań

histogram(
  data = dane,
  x = Cena,
  bins = 100,
  title = "Rozkład cen mieszkań w zł"
)

# Histogram ceny za metr

histogram(
  data = dane,
  x = `Cena za metr`,
  bins = 50,
  title = "Rozkład ceny za metr kwadratowy mieszkań w zł/m^2"
)

# Histogram powierzchni mieszkań

histogram(
  data = dane,
  x = Powierzchnia,
  bins = 50,
  title = "Rozkład powierzchni mieszkań w m^2"
)

# Histogram liczby pokoi

histogram(
  data = dane,
  x = `Liczba pokoi`,
  binwidth = 1,
  title = "Rozkład liczby pokoi"
)
```

## Analiza korelacji

Macierz korelacji

``` {r macierz-korelacji, fig.align='center', fig.width=6, fig.height=4}

korelacje <- dane %>%
  select(where(is.numeric)) %>%
  cor()

corrplot(korelacje,
         method = "color",
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45,
         number.cex = 0.75,
         tl.cex = 0.75)

```

## Analiza braków danych

Krótkie podsumowanie braków danych (wykres słupkowy?)

```{r zliczenie-brakow-danych, fig.align='center', fig.width=6, fig.height=4}
braki_danych <- colSums(is.na(dane)) / nrow(dane)
ggplot(mapping = aes(x = names(braki_danych), y = braki_danych)) +
  geom_col(fill = "firebrick") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Udział braków danych wg zmiennej",
       x = NULL,
       y = NULL) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 90))

```

## Analiza obserwacji odstających

Zrobić boxploty

``` {r box-ploty, fig.align='center', fig.width=6, fig.height=4}

ggplot(dane, aes(y = Powierzchnia)) +
  geom_boxplot() +
  theme_bw()

```

# Obróbka zmiennych

``` {r filtrowanie-danych}



```

## Kodowanie zmiennych kategorycznych

## Normalizacja zmiennych numerycznych

# 2 metody

## Analiza głównych składowych (PCA)



``` {r pca-setup}

dane_pca <- dane %>%
  select(Cena, Powierzchnia, `Liczba pokoi`, Piętro, `Rok budowy`)

cor_pca <- cor(dane_pca)

cortest.bartlett(cor_pca)

```


```{r pca-1, fig.align='center', fig.width=6, fig.height=4}

pca <- prcomp(dane_pca, center = TRUE, scale. = TRUE)

fviz_screeplot(pca, geom = "line", addlabels = TRUE)

```

```{r pca-2}

get_eig(pca)

```
Korzystając z kryterium Keisera można określić, że mieszkania można określić za pomocą dwóch zmiennych, ponieważ dla nich wartości własne są większe od 1. Taki sam wniosek można wyciągnąć na podstawie oceny wykresu osypiska, gdyż po drugim wymiarze zmiana wariancji jest znacznie mniejsza.

## Analiza korespondencji (CA)

# Wizualizacja metod

## Wizualizacje PCA

```{r wizualizacje-pca, fig.align='center', fig.width=6, fig.height=4}

pcaVars <- get_pca_var(pca)

ggcorrplot(pcaVars$coord[, 1:2],
           colors = c("blue","white","blue"),
           tl.cex=9,
           lab=TRUE,
           lab_size=3
           )


```


## Wizualizacje CA


# Wnioski
